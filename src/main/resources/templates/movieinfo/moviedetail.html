<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="../css/bootstrap.min.css">
<style type="text/css">
#header-container {
	width: 100%;
	background-color: #ffffff;
	position: relative;
	z-index: 10;
}
footer-container {
	position: relative;
	width: 100%;
}
.tab-container {
    display: flex;
    justify-content: center;
    border-bottom: 2px solid #ddd;
    margin-top: 20px;
}
.tab {
    padding: 10px 20px;
    cursor: pointer;
    font-weight: bold;
    color: #666;
}
.tab.active {
    border-bottom: 2px solid black;
    color: black;
}
#tab-content {
    margin-top: 20px;
    padding: 10px;
}
.review-input {
    margin-bottom: 20px;
}

.review-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.review-profile {
    margin-right: 15px;
}

.review-profile img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
}

.review-content {
    flex: 1;
}

.review-meta {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
}

.review-text {
    font-size: 16px;
}

.review-like {
    font-size: 14px;
    color: #666;
    margin-left: 10px;
    align-self: center;
}

.content-box {
    width: 900px;
    margin: 0 auto;
}

.review-input-container {
    position: relative;
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 5px;
    display: flex;
    align-items: center;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.review-input-container textarea {
    width: 100%;
    height: 80px;
    border: none;
    padding: 10px 120px 10px 10px;
    resize: none;
    outline: none;
    font-size: 15px;
}

.review-input-container button {
    position: absolute;
    right: 0;
    top: 0;
    width: 110px;
    height: 100%;
    border: none;
    background-color: #444;
    color: white;
    cursor: pointer;
    font-size: 15px;
    transition: background-color 0.2s ease;
}

.review-input-container button:hover {
    background-color: #333;
}

.char-count {
    position: absolute;
    bottom: 10px;
    right: 120px;
    color: #999;
    font-size: 13px;
}

.review-input-container textarea {
	width: 100%;
	height: 120px;
	border: none;
	padding: 15px;
	border-radius: 10px;
	resize: none;
	outline: none;
	font-size: 16px;
	line-height: 1.6;
	background-color: #f9f9f9;
}

.synopsis-textarea {
    width: 100%;
    height: 160px; /* í•„ìš”ì— ë”°ë¼ ì¡°ì • ê°€ëŠ¥ */
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 15px;
    font-size: 15px;
    color: #333;
    resize: none;
    overflow-y: auto;
    background-color: #f9f9f9;
    line-height: 1.6;
    white-space: pre-wrap;
}


</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

	<!-- í—¤ë” -->
	<div id="header-container">
		<div th:replace="~{layouts/header}"></div>
	</div>

	<div class="container" align="center" style="margin-top:100px; padding-bottom:100px;">
		<table style="width: 900px; margin: 0 auto;">
			<tr>
				<td rowspan="5" style="width:310px; padding-right:50px;">
					<img alt="í¬ìŠ¤í„°" th:src="|/movie_poster/${movie_info.poster1}|" width="300" height="400">
				</td>
				<td align="left" style="height:50px;">
					<h1 style="font-size: 28px; font-weight: 800; margin: 0;">
						[[${movie_info.title}]]
					</h1>
				</td>
			</tr>
			<tr>
				<td style="height:20px; font-size: 15px; color: #444;">
					[[${movie_info.releasedate}]] ê°œë´‰ |
					â± [[${movie_info.runningtime}]]ë¶„ |
					<span style="color: orange; font-weight: bold;">
						[[${movie_info.agerating}]]ì„¸ ì´ìƒ ê´€ëŒê°€
					</span> |
					<strong>[[${movie_info.total}]]</strong>ëª…
				</td>
			</tr>
			
			<!-- ë²„íŠ¼ ì˜ì—­ (ì˜ˆê³ í¸ ì¬ìƒ / ì°œ ) -->
			<tr>
				<td colspan="2" align="left" style="padding-top: 10px;">
					<button class="btn btn-outline-dark btn-sm" style="margin-right: 10px;">â–¶ ì˜ˆê³ í¸ ì¬ìƒ</button>
					<button id="wish-btn" class="btn btn-outline-dark btn-sm">ğŸ¤ 0</button>
				</td>
			</tr>
			
			<tr>
			    <td align="left">
			        <textarea class="synopsis-textarea" readonly>[[${movie_info.synopsis}]]</textarea>
			    </td>
			</tr>

			<tr>
				<td style="height:50px;">
					<a href="#" style="
						display: inline-block;
						width: 250px;
						height: 60px;
						line-height: 60px;
						background-color: rgb(255, 128, 64);
						color: white;
						border-radius: 30px;
						font-weight: bold;
						text-align: center;
						font-size: 20px;
						text-decoration: none;
						transition: background-color 0.2s ease;">
						ì˜ˆë§¤í•˜ê¸°
					</a>
				</td>
			</tr>
		</table>
	</div>


	<!-- ğŸ”¹ ìƒì„¸ì •ë³´ | ê´€ëŒí‰(0) íƒ­ -->
	<div class="tab-container">
	    <span class="tab active" id="detail-tab">ìƒì„¸ì •ë³´</span>
	    <span class="tab" id="review-tab">ê´€ëŒí‰ (<span id="review-count" th:text="${reviewCount}">0</span>)</span>
	</div>

	<div id="detail-section" class="content-box">
	<!-- ì´ê³³ì— Ajaxë¡œ ì˜í™”ì •ë³´ê°€ ë™ì ìœ¼ë¡œ ë“¤ì–´ì˜´ -->
	</div>

	<!-- ğŸ”¹ ë¦¬ë·° ì…ë ¥ & ëª©ë¡ -->
	<div id="tab-content" style="display: none;">

		
	    <div id="review-section" class="content-box">
	        <!-- ë¦¬ë·° ì…ë ¥ í¼ -->
	        <!-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ì…ë ¥ ê°€ëŠ¥ -->
			<div class="review-input" th:if="${sessionMemid != null}">
			    <div class="review-input-container">
			        <textarea id="comment" maxlength="330" placeholder="ê´€ëŒí‰ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
			        <button id="submit-review-btn">ê´€ëŒí‰ ì‘ì„±</button>
			        <div class="char-count"><span id="char-count-num"></span></div>
			    </div>
			    <input type="number" id="rating" min="1" max="10" placeholder="ë³„ì  (1~10)" style="margin-top:10px;width:110px;">
			</div>
	
	        <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ -->
	        <div class="review-input" th:if="${sessionMemid == null}">
	            <p>ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ê±°ë‚˜ ê³µê°ì„ í•˜ë ¤ë©´ <a href="/member/loginForm" style="text-decoration: none;">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
	        </div>

			<div style="text-align: right; margin: 10px 0;">
			    <span class="review-sort-btn" data-sort="latest" style="cursor: pointer; font-weight: bold; margin-right: 10px;">ğŸ“„ ìµœì‹ ìˆœ</span>
			    <span class="review-sort-btn" data-sort="like" style="cursor: pointer;">ğŸ‘ ê³µê°ìˆœ</span>
			</div>
	
	        <!-- ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ -->
	        <ul id="review-list">
	            <!-- AJAXë¡œ ë¶ˆëŸ¬ì˜¨ ë¦¬ë·°ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
	        </ul>
	    </div>
	</div>


	<!--  footer -->
	<div id="footer-container">
		<div th:replace="~{layouts/footer}"></div>
	</div>

<script th:inline="javascript">
let sessionUserId = /*[[${sessionMemid}]]*/ '';
let moviecode = /*[[${movie_info.moviecode}]]*/ 1;
let currentSort = 'latest'; // ê¸°ë³¸ê°’: ìµœì‹ ìˆœ

//ì°œ ìƒíƒœ ë° ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateWishInfo() {
    $.get(`/movieinfo/wish/${moviecode}/count`, function(count) {
        $.get(`/movieinfo/wish/${moviecode}/check`, function(isWished) {
            const heart = isWished ? 'â¤ï¸' : 'ğŸ¤';
            $("#wish-btn").html(`${heart} ${count}`);
        });
    });
}

// ì°œ ë²„íŠ¼ í´ë¦­
$(document).on('click', '#wish-btn', function () {
    if (!sessionUserId) {
        alert("ì°œí•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.");
        window.location.href = "/member/loginForm";
        return;
    }

    $.get(`/movieinfo/wish/${moviecode}/check`, function (isWished) {
        const method = isWished ? "DELETE" : "POST";
        $.ajax({
            url: `/movieinfo/wish/${moviecode}`,
            type: method,
            success: function () {
                updateWishInfo();
            },
            error: function (xhr) {
                alert("ìš”ì²­ ì‹¤íŒ¨: " + xhr.responseText);
            }
        });
    });
});

function loadReviews() {
    $.ajax({
        url: `/movieinfo/review?moviecode=${moviecode}&start=1&end=100&sort=${currentSort}`,
        type: "GET",
        success: function (reviews) {
            $("#review-list").html("");
            $("#review-count").text(reviews.length);
            
            let myReviewHtml = "";
            let otherReviewsHtml = "";

            reviews.forEach(function (r) {
                let gradeImage = '';
                if (r.grade === 'vvip') gradeImage = '/gradeimage/vvip.jpg';
                else if (r.grade === 'vip') gradeImage = '/gradeimage/vip.jpg';
                else if (r.grade === 'gold') gradeImage = '/gradeimage/gold.jpg';
                else if (r.grade === 'silver') gradeImage = '/gradeimage/silver.jpg';
                else gradeImage = '/gradeimage/basic.jpg';

                const isMyReview = r.user_id === sessionUserId;
                
                // ë‚ ì§œ í˜•ì‹
                const date = new Date(r.logtime);
                const formattedDate = date.getFullYear() + '.' +
                    String(date.getMonth() + 1).padStart(2, '0') + '.' +
                    String(date.getDate()).padStart(2, '0') + ' ' +
                    String(date.getHours()).padStart(2, '0') + ':' +
                    String(date.getMinutes()).padStart(2, '0');
                    
                    
                const reviewHtml = `
                    <li class="review-item">
                        <div class="review-profile">
                            <img src="${gradeImage}" alt="ë“±ê¸‰ì´ë¯¸ì§€">
                        </div>
                        <div class="review-content">
                            <div class="review-meta">
                                <strong>${r.user_id}</strong> (â­ ${r.rating}/10) &nbsp; ${formattedDate}
                                ${isMyReview ? '<span class="badge bg-secondary">ë‚˜ì˜ë¦¬ë·°</span>' : ''}
                            </div>
                            <div class="review-text">${r.review_comment}</div>
                            ${isMyReview ? `
                                <div style="margin-top: 5px;">
                                    <button class="edit-review-btn btn btn-sm btn-outline-primary" data-id="${r.reviewcode}">í¸ì§‘</button>
                                    <button class="delete-review-btn btn btn-sm btn-outline-danger" data-id="${r.reviewcode}">ì‚­ì œ</button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="review-like">
	                        ğŸ‘ <span id="like-count-${r.reviewcode}">0</span>
	                        <button class="like-btn btn btn-sm btn-outline-success" data-id="${r.reviewcode}">ì¢‹ì•„ìš”</button>
	                        <button class="unlike-btn btn btn-sm btn-outline-secondary" data-id="${r.reviewcode}">ì·¨ì†Œ</button>
                    	</div>
                    </li>
                `;

                if (isMyReview) {
                    myReviewHtml = reviewHtml;
                } else {
                    otherReviewsHtml += reviewHtml;
                }
            });

            $("#review-list").html(myReviewHtml + otherReviewsHtml);
          	//ë¦¬ë·° ë¶ˆëŸ¬ì˜¬ ë•Œ ì¢‹ì•„ìš” ê°œìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
            reviews.forEach(function(r) {
                $.ajax({
                    url: `/movieinfo/review/${r.reviewcode}/likes`,
                    type: "GET",
                    success: function(count) {
                        $(`#like-count-${r.reviewcode}`).text(count);
                    },
                    error: function() {
                        $(`#like-count-${r.reviewcode}`).text('0');
                    }                    
                });
            });            
        },
        error: function () {
            alert("ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
}

$(document).ready(function () {

    sessionUserId = /*[[${sessionMemid}]]*/ '';
    moviecode = /*[[${movie_info.moviecode}]]*/ 1;

    $(document).on('click', '.review-sort-btn', function () {
        $(".review-sort-btn").css("font-weight", "normal");
        $(this).css("font-weight", "bold");

        currentSort = $(this).data("sort"); // latest or like
        loadReviews(); // ì •ë ¬ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    });
    
    $(".tab").click(function () {
        $(".tab").removeClass("active");
        $(this).addClass("active");

        if ($(this).attr("id") === "review-tab") {
            $("#tab-content").show();
            $("#detail-section").hide();
            loadReviews();
        } else {
            $("#tab-content").hide();
        }
    });

    $("#detail-tab").click(function () {
        $(".tab").removeClass("active");
        $(this).addClass("active");
        $("#tab-content").hide();
        $("#detail-section").show();
        const info = /*[[${movie_info}]]*/ null;
        const html = `
            <h4 style="margin-top: 30px; font-weight: bold;">ì˜í™”ì •ë³´</h4>
            <p><strong>ì¥ë¥´:</strong> ${info.genre}</p>
            <p><strong>ê°ë…:</strong> ${info.director}</p>
            <p><strong>ì¶œì—°:</strong> ${info.actors}</p>
            <p><strong>ì œì‘êµ­ê°€:</strong> ${info.country}</p>
            <p><strong>ìƒì˜ë“±ê¸‰:</strong> ${info.agerating}ì„¸ ì´ìƒ ê´€ëŒê°€</p>
            <p><strong>ê°œë´‰ì¼:</strong> ${info.releasedate}</p>
            <p><strong>ì¬ìƒì‹œê°„:</strong> ${info.runningtime}ë¶„</p>
            <p><strong>ëˆ„ì  ê´€ê°ìˆ˜:</strong> ${info.total}ëª…</p>
        `;
        $("#detail-section").html(html);
    });

    $("#submit-review-btn").click(function () {
        const ratingVal = parseInt($("#rating").val());
        const commentVal = $("#comment").val();

        // ë³„ì  ì²´í¬
        if (isNaN(ratingVal) || ratingVal < 1 || ratingVal > 10) {
            alert("ë³„ì ì€ 1ë¶€í„° 10 ì‚¬ì´ì˜ ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            $("#rating").val("");
            return;
        }

        // ë°”ì´íŠ¸ ì²´í¬ ì¶”ê°€
        if (calculateByte(commentVal) > 255) {
            alert("ê´€ëŒí‰ ë‚´ìš©ì´ ë°”ì´íŠ¸ ì œí•œì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ì¤„ì—¬ì£¼ì„¸ìš”.");
            return;
        }

        $.ajax({
            url: `/movieinfo/review/check?moviecode=${moviecode}`,
            type: "GET",
            success: function (exists) {
                if (exists) {
                    alert("ì´ë¯¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì…¨ìŠµë‹ˆë‹¤.");
                    return;
                }
                const review = {
                    moviecode: moviecode,
                    user_id: sessionUserId,
                    review_comment: commentVal,
                    rating: ratingVal
                };
                $.ajax({
                    url: "/movieinfo/review",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(review),
                    success: function () {
                        $("#comment").val("");
                        $("#rating").val("");
                        $('#char-count-num').text('0/255 byte');
                        loadReviews();
                    }
                });
            }
        });
    });
    updateWishInfo();

    $("#detail-tab").click();
});

//ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
$(document).on('click', '.delete-review-btn', function () {
    const reviewcode = $(this).data('id');
    if (confirm("ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        $.ajax({
            url: `/movieinfo/review/${reviewcode}`,
            type: "DELETE",
            success: function () {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadReviews(); // ì¶”ê°€
            },
            error: function () {
                alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }
});

//ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
$(document).on('click', '.edit-review-btn', function () {
    const reviewcode = $(this).data('id');
    const newComment = prompt("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:");
    const newRating = prompt("ìˆ˜ì •í•  ë³„ì ì„ ì…ë ¥í•˜ì„¸ìš” (1~10):");

    if (newComment && newRating) {
        $.ajax({
            url: `/movieinfo/review/${reviewcode}`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify({ review_comment: newComment, rating: newRating }),
            success: function () {
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadReviews(); // ì¶”ê°€
            },
            error: function () {
                alert("ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }
});

function calculateByte(str) {
    let totalBytes = 0;

    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);

        if (char <= 0x007F) {
            totalBytes += 1; // ASCII (ì˜ì–´, ìˆ«ì, ê¸°ë³¸íŠ¹ìˆ˜ë¬¸ì)
        } else if (char <= 0x07FF) {
            totalBytes += 2; // ê¸°íƒ€ ì–¸ì–´ íŠ¹ìˆ˜ë¬¸ì
        } else if (char <= 0xFFFF) {
            totalBytes += 3; // í•œê¸€ í¬í•¨ ëŒ€ë¶€ë¶„ ë¬¸ì
        } else {
            totalBytes += 4; // ì´ëª¨ì§€, íŠ¹ìˆ˜ ìœ ë‹ˆì½”ë“œ ë¬¸ì
        }
    }
    return totalBytes;
}

$(document).on('input', '#comment', function() {
    let text = $(this).val();
    let maxBytes = 255; // 85ì * 3ë°”ì´íŠ¸ ê¸°ì¤€ = 255ë°”ì´íŠ¸
    let currentBytes = calculateByte(text);

    if (currentBytes > maxBytes) {
        alert("í•œê¸€ ê¸°ì¤€ ìµœëŒ€ 85ì(255 ë°”ì´íŠ¸)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.");

        // ì´ˆê³¼ëœ ì…ë ¥ ì˜ë¼ë‚´ê¸°
        while (calculateByte(text) > maxBytes) {
            text = text.slice(0, -1); // ë§¨ ë’¤ ë¬¸ì í•˜ë‚˜ì”© ì‚­ì œ
        }

        $(this).val(text); // ì´ˆê³¼ëœ ë¶€ë¶„ ì œê±°í•œ í…ìŠ¤íŠ¸ ì„¤ì •
        currentBytes = calculateByte(text); // ìµœì¢… ë°”ì´íŠ¸ ì¬ê³„ì‚°
    }

    // í˜„ì¬ ê¸€ììˆ˜ë¥¼ 85ì í•œê¸€ê¸°ì¤€ìœ¼ë¡œ í™˜ì‚°í•˜ì—¬ í‘œì‹œ
    $('#char-count-num').text(`${currentBytes}/255 byte`);
});

// ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
$(document).on('click', '.like-btn', function() {
    const reviewcode = $(this).data('id');
    $.ajax({
        url: `/movieinfo/review/like`,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ reviewcode: reviewcode }),
        success: function() {
            alert("ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤.");
            loadReviews();
        },
        error: function(xhr) {
            alert(xhr.responseText);
        }
    });
});

// ì¢‹ì•„ìš” ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸
$(document).on('click', '.unlike-btn', function() {
    const reviewcode = $(this).data('id');
    $.ajax({
        url: `/movieinfo/review/${reviewcode}/like`,
        type: "DELETE",
        success: function() {
            alert("ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.");
            loadReviews();
        },
        error: function() {
            alert("ì·¨ì†Œ ì‹¤íŒ¨");
        }
    });
});

</script>


</body>
</html>
